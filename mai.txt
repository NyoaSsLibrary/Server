-- ======= Section: Services & Constants ======= --
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local pgui = Player:WaitForChild("PlayerGui")

loadstring(game:HttpGet("https://raw.githubusercontent.com/NyoaSsLibrary/Server/refs/heads/main/obfuscated_Fps_Ping.lua.txt"))()

local CONFIG_FILE = "NyoaSs_Config.json"

local DEFAULT_CONFIG = {
    Xray = false,
    BaseESP = false,
    PlotTimer = false,
    BestValueESP = false,
    BestPriceESP = false,
    PlayerESP = false,
    NyoaFly = false,
    NyoaBoost = false,
    Float = false,
    NyoaFlyGrapple = false,
    InfiniteJump = false,
    Invisible = false,
    SemiInvisible = false,
    FriendsAllowed = false,
    AutoSteal = false,
    KickAfterSteal = false,
    AntiRagdoll = false,
    AntiKnockback = false,
    AntiEffects = false,
    DeleteParts = false,
}

local Config = DEFAULT_CONFIG

local function loadConfig()
    if isfile and readfile and isfile(CONFIG_FILE) then
        local success, loaded = pcall(function()
            return game:GetService("HttpService"):JSONDecode(readfile(CONFIG_FILE))
        end)
        if success and type(loaded) == "table" then
            for k, v in pairs(loaded) do
                if DEFAULT_CONFIG[k] ~= nil then
                    Config[k] = v
                end
            end
        end
    end
end

local function saveConfig()
    if writefile then
        pcall(function()
            writefile(CONFIG_FILE, game:GetService("HttpService"):JSONEncode(Config))
        end)
    end
end

loadConfig()

-- ======= Section: Notify Function ======= --
local function createNotify(text)
    local notify = Instance.new("Frame")
    notify.Size = UDim2.new(0,300,0,56)
    notify.Position = UDim2.new(0.5,-150,0,-70)
    notify.BackgroundColor3 = Color3.fromRGB(20,20,24)
    notify.BorderSizePixel = 0
    notify.ClipsDescendants = true
    notify.ZIndex = 1000
    notify.Parent = pgui

    Instance.new("UICorner",notify).CornerRadius = UDim.new(0,10)
    local stroke = Instance.new("UIStroke",notify)
    stroke.Color = Color3.new(1,1,1)
    stroke.Transparency = 0.8
    stroke.Thickness = 1

    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1,-50,0,22)
    title.Position = UDim2.new(0,12,0,8)
    title.BackgroundTransparency = 1
    title.Text = text
    title.TextColor3 = Color3.new(1,1,1)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 15
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.ZIndex = 1000
    title.Parent = notify

    local author = Instance.new("TextLabel")
    author.Size = UDim2.new(1,-50,0,16)
    author.Position = UDim2.new(0,12,0,30)
    author.BackgroundTransparency = 1
    author.Text = "by Slivkineepy | NyoaSS"
    author.TextColor3 = Color3.fromRGB(160,160,170)
    author.Font = Enum.Font.Gotham
    author.TextSize = 12
    author.TextXAlignment = Enum.TextXAlignment.Left
    author.ZIndex = 1000
    author.Parent = notify

    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0,24,0,24)
    closeBtn.Position = UDim2.new(1,-32,0,8)
    closeBtn.BackgroundTransparency = 1
    closeBtn.Text = "x"
    closeBtn.TextColor3 = Color3.fromRGB(180,180,180)
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 18
    closeBtn.ZIndex = 1000
    closeBtn.Parent = notify

    local barBg = Instance.new("Frame")
    barBg.Size = UDim2.new(1,-24,0,3)
    barBg.Position = UDim2.new(0,12,1,-10)
    barBg.BackgroundColor3 = Color3.fromRGB(40,40,45)
    barBg.ZIndex = 1000
    barBg.Parent = notify
    Instance.new("UICorner",barBg).CornerRadius = UDim.new(0,2)

    local bar = Instance.new("Frame")
    bar.Size = UDim2.new(1,0,1,0)
    bar.BackgroundColor3 = Color3.fromRGB(100,180,255)
    bar.ZIndex = 1000
    bar.Parent = barBg
    Instance.new("UICorner",bar).CornerRadius = UDim.new(0,2)

    local shown = false
    local function hide()
        if shown then
            shown = false
            TweenService:Create(notify,TweenInfo.new(0.4,Enum.EasingStyle.Quint),{Position=UDim2.new(0.5,-150,0,-70)}):Play()
            task.wait(0.45)
            notify:Destroy()
        end
    end

    local function show()
        shown = true
        TweenService:Create(notify,TweenInfo.new(0.5,Enum.EasingStyle.Quint),{Position=UDim2.new(0.5,-150,0,12)}):Play()
        local t = TweenService:Create(bar,TweenInfo.new(5,Enum.EasingStyle.Linear),{Size=UDim2.new(0,0,1,0)})
        t:Play()
        t.Completed:Wait()
        if shown then hide() end
    end

    closeBtn.MouseButton1Click:Connect(hide)
    task.spawn(show)
end

task.spawn(function()
    task.wait(0.5)
    createNotify("NyoaSs has been loaded ðŸŽ…")
end)

-- ======= Section: Drag Function ======= --
local function Drag(frame, handle)
    handle = handle or frame
    local dragging = false
    local dragInput, dragStart, startPos

    local function update(input)
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    handle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position

            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    handle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input == dragInput or input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            update(input)
        end
    end)
end

-- ======= Section: Anti-Dump & Anti-Spy Protection ======= --
spawn(function()
    if debug and debug.getinfo then
        local info = debug.getinfo(2, "S")
        if info and info.source and string.find(info.source, "@") then
            pcall(function() Player:Kick("no dumping bud") end)
        end
    end

    local badNames = {
        ExplorerSelections = true, EditAttributeButton = true, Dex = true, DEX = true,
        SimpleSpy = true, TurtleSpy = true, AwesomeExplorer = true, Hydroxide = true,
        RemoteSpy = true, RemoteBrowser = true, PropertiesFrame = true, ExplorerPanel = true
    }

    local badAssets = {
        ["rbxassetid://5054663650"] = true,
        ["rbxassetid://1427967925"] = true,
        ["rbxassetid://9887697099"] = true,
        ["rbxassetid://9887696628"] = true,
        ["rbxassetid://9896472554"] = true,
        ["rbxassetid://9887696922"] = true,
        ["rbxassetid://9887696242"] = true,
        ["rbxassetid://169476802"] = true,
        ["rbxassetid://5642383285"] = true,
        ["rbxassetid://1204397029"] = true
    }

    local badPhrases = {
        "clear logs", "exclude", "ignores remotes", "remotespy", "simple spy", "turtle spy",
        "remote spy", "invoke", "fire server", "block remote", "log remote", "spy remote"
    }

    local function isBad(obj)
        if not obj then return false end
        if badNames[obj.Name] then return true end
        if obj:IsA("ImageLabel") or obj:IsA("ImageButton") then
            local success, img = pcall(function() return obj.Image end)
            if success and badAssets[img] then return true end
        end
        local n = string.lower(obj.Name or "")
        if string.find(n, "dex") or string.find(n, "spy") then
            if not string.find(n, "index") then return true end
        end
        return false
    end

    local function checkText(o)
        if o:IsA("TextLabel") or o:IsA("TextButton") or o:IsA("TextBox") then
            local success, t = pcall(function() return o.Text end)
            if success and t then
                local l = string.lower(t)
                for _, p in badPhrases do
                    if string.find(l, p) then
                        pcall(function() Player:Kick("Ey man spy") end)
                        return
                    end
                end
            end
        end
    end

    local hits = 0
    local last = 0

    CoreGui.DescendantAdded:Connect(function(o)
        spawn(function()
            if isBad(o) then
                local now = tick()
                if now - last > 5 then hits = 0 end
                last = now
                hits = hits + 1
                if hits >= 4 then pcall(function() Player:Kick("tool detected") end) end
            end
            checkText(o)
        end)
    end)

    local old = print
    local r = false
    print = function(...)
        if r then return old(...) end
        r = true
        for _, v in {...} do
            if type(v) == "string" then
                local l = string.lower(v)
                if string.find(l, "remotespy") or string.find(l, "blacklisted") then
                    r = false
                    pcall(function() Player:Kick("logging detected") end)
                    return
                end
            end
        end
        r = false
        old(...)
    end
end)

-- ======= Section: Universal Feature Window ======= --
local activeWindows = {}

local function CreateFeatureWindow(name, text, startFunc, stopFunc, configKey)
    if activeWindows[name] then return end
    activeWindows[name] = true

    local gui = Instance.new("ScreenGui")
    gui.Name = "NyoaSs_"..name
    gui.ResetOnSpawn = false
    gui.Parent = pgui

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0,140,0,44)
    frame.Position = UDim2.new(0.02,0,0.33 + (#activeWindows * 0.06),0)
    frame.BackgroundColor3 = Color3.fromRGB(15,15,15)
    frame.Active = true
    frame.Draggable = true
    frame.Parent = gui
    Instance.new("UICorner",frame).CornerRadius = UDim.new(0,10)

    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1,-12,1,-12)
    btn.Position = UDim2.new(0,6,0,6)
    btn.BackgroundColor3 = Color3.fromRGB(35,35,35)
    btn.Text = text..": OFF"
    btn.TextColor3 = Color3.new(1,1,1)
    btn.TextScaled = true
    btn.Font = Enum.Font.GothamBold
    btn.Parent = frame
    Instance.new("UICorner",btn).CornerRadius = UDim.new(0,8)

    local close = Instance.new("TextButton")
    close.Size = UDim2.new(0,26,0,26)
    close.Position = UDim2.new(1,-16,0,-10)
    close.BackgroundColor3 = Color3.fromRGB(190,30,30)
    close.Text = "X"
    close.TextColor3 = Color3.new(1,1,1)
    close.TextScaled = true
    close.Font = Enum.Font.GothamBold
    close.Parent = frame
    Instance.new("UICorner",close).CornerRadius = UDim.new(0,8)

    local enabled = Config[configKey] or false

    local function update(state)
        enabled = state
        Config[configKey] = state
        btn.Text = text .. (state and ": ON" or ": OFF")
        btn.BackgroundColor3 = state and Color3.fromRGB(0,170,255) or Color3.fromRGB(35,35,35)
        if state then startFunc() else stopFunc() end
    end

    btn.MouseButton1Click:Connect(function()
        update(not enabled)
    end)

    close.MouseButton1Click:Connect(function()
        update(false)
        gui:Destroy()
        activeWindows[name] = nil
    end)

    if enabled then update(true) end
end

-- ======= Section: Xray ======= --
local obj = Workspace:WaitForChild("Plots")

local xrayEnabled = false
local xrayConnection = nil

local function XrayOn(cur)
    if cur:FindFirstChild("AnimationController") then return end
    for _, v in pairs(cur:GetChildren()) do
        if v:IsA("BasePart") and not v.Parent:FindFirstChild("Humanoid") then
            v.LocalTransparencyModifier = 0.75
        end
        XrayOn(v)
    end
end

local function XrayOff(cur)
    if cur:FindFirstChild("AnimationController") then return end
    for _, v in pairs(cur:GetChildren()) do
        if v:IsA("BasePart") and not v.Parent:FindFirstChild("Humanoid") then
            v.LocalTransparencyModifier = 0
        end
        XrayOff(v)
    end
end

-- ======= Section: Plot ESP ======= --
local PlotESP_Data = {}

local function CreatePlotESP(plot)
    if not plot or not plot:FindFirstChild("Spawn") or PlotESP_Data[plot] then return end
    local spawn = plot.Spawn

    if spawn:FindFirstChild("PlotESP_Billboard") then spawn.PlotESP_Billboard:Destroy() end

    local bill = Instance.new("BillboardGui")
    bill.Name = "PlotESP_Billboard"
    bill.Adornee = spawn
    bill.Size = UDim2.new(0,200,0,80)
    bill.StudsOffset = Vector3.new(0,25,0)
    bill.AlwaysOnTop = true
    bill.Parent = spawn

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1,0,1,0)
    frame.BackgroundTransparency = 1
    frame.Parent = bill

    local owner = Instance.new("TextLabel")
    owner.Size = UDim2.new(1,0,0.5,0)
    owner.BackgroundTransparency = 1
    owner.TextColor3 = Color3.fromRGB(0,255,255)
    owner.Font = Enum.Font.Arcade
    owner.TextSize = 28
    owner.TextStrokeTransparency = 0
    owner.Text = plot:FindFirstChild("Owner") and "Owner: "..plot.Owner.Value or "Free"
    owner.Parent = frame

    local dist = Instance.new("TextLabel")
    dist.Size = UDim2.new(1,0,0.5,0)
    dist.Position = UDim2.new(0,0,0.5,0)
    dist.BackgroundTransparency = 1
    dist.TextColor3 = Color3.fromRGB(255,255,100)
    dist.Font = Enum.Font.Arcade
    dist.TextSize = 24
    dist.TextStrokeTransparency = 0
    dist.Parent = frame

    local conn = RunService.Heartbeat:Connect(function()
        if Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") then
            local d = (Player.Character.HumanoidRootPart.Position - spawn.Position).Magnitude
            dist.Text = string.format("%.0f studs", d)
            if plot:FindFirstChild("Owner") then owner.Text = "Owner: "..plot.Owner.Value end
        end
    end)

    PlotESP_Data[plot] = {bill=bill, owner=owner, dist=dist, conn=conn}
end

local function RemovePlotESP(plot)
    if not PlotESP_Data[plot] then return end
    if PlotESP_Data[plot].bill then PlotESP_Data[plot].bill:Destroy() end
    if PlotESP_Data[plot].conn then PlotESP_Data[plot].conn:Disconnect() end
    PlotESP_Data[plot] = nil
end

-- ======= Section: Plot Timer ESP ======= --
local PlotTimeESP_Data = {}

local function GetPlotTime(plot)
    if plot:FindFirstChild("Timer") then return plot.Timer.Value end
    if plot:FindFirstChild("TimeLeft") then return plot.TimeLeft.Value end
    if plot:FindFirstChild("Time") then return plot.Time.Value end
    if plot:GetAttribute("TimeLeft") then return plot:GetAttribute("TimeLeft") end
    if plot:GetAttribute("Timer") then return plot:GetAttribute("Timer") end
    return nil
end

local function CreateTimeESP(plot)
    if not plot or not plot:FindFirstChild("Spawn") or PlotTimeESP_Data[plot] then return end
    local spawn = plot.Spawn

    local bill = Instance.new("BillboardGui")
    bill.Name = "PlotTimeESP"
    bill.Adornee = spawn
    bill.Size = UDim2.new(0,200,0,40)
    bill.StudsOffset = Vector3.new(0,15,0)
    bill.AlwaysOnTop = true
    bill.Parent = spawn

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1,0,1,0)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.fromRGB(100,255,100)
    label.Font = Enum.Font.Arcade
    label.TextSize = 30
    label.TextStrokeTransparency = 0
    label.Text = "Time: âˆž"
    label.Parent = bill

    local conn = RunService.Heartbeat:Connect(function()
        local t = GetPlotTime(plot)
        if t and t > 0 then
            local m = math.floor(t/60)
            local s = t % 60
            label.Text = string.format("Time: %02d:%02d", m, s)
            label.TextColor3 = t < 60 and Color3.fromRGB(255,50,50) or Color3.fromRGB(100,255,100)
        else
            label.Text = "Time: âˆž"
            label.TextColor3 = Color3.fromRGB(150,150,150)
        end
    end)

    PlotTimeESP_Data[plot] = {bill = bill, label = label, conn = conn}
end

local function RemoveTimeESP(plot)
    if not PlotTimeESP_Data[plot] then return end
    if PlotTimeESP_Data[plot].bill then PlotTimeESP_Data[plot].bill:Destroy() end
    if PlotTimeESP_Data[plot].conn then PlotTimeESP_Data[plot].conn:Disconnect() end
    PlotTimeESP_Data[plot] = nil
end

-- ======= Section: Best Value ESP (Brainrot) ======= --
local brainrotEspEnabled = false
local activeBestBrainrotESPs = {}

local function parseNumber(txt)
    local cleaned = txt:gsub(',',''):gsub('%s+',''):gsub('%$','')
    local num,suffix = cleaned:match('(%d+%.?%d*)([kKmMb]?)%/s')
    if not num then return nil end
    local value = tonumber(num)
    if not value then return nil end
    suffix = suffix:lower()
    if suffix == 'k' then value = value * 1e3
    elseif suffix == 'm' then value = value * 1e6
    elseif suffix == 'b' then value = value * 1e9 end
    return value
end

local function getRainbowColor()
    local t = tick() * 2
    local r = math.floor(math.sin(t) * 127 + 128)
    local g = math.floor(math.sin(t + 2) * 127 + 128)
    local b = math.floor(math.sin(t + 4) * 127 + 128)
    return Color3.fromRGB(r, g, b)
end

local function getColorFromModel(model, labelText)
    local fullText = (model.Name or ''):lower() .. ' ' .. (labelText or ''):lower()
    if fullText:find('gold') then return Color3.fromRGB(255,215,0)
    elseif fullText:find('diamond') then return Color3.fromRGB(0,170,255)
    elseif fullText:find('rainbow') then return 'rainbow'
    elseif fullText:find('lava') then return Color3.fromRGB(255,69,0)
    elseif fullText:find('bloodrot') then return Color3.fromRGB(139,0,0)
    elseif fullText:find('candy') then return Color3.fromRGB(255,105,180)
    elseif fullText:find('galaxy') then return Color3.fromRGB(170,0,255)
    elseif fullText:find('yin yang') then return Color3.fromRGB(255,255,255)
    elseif fullText:find('chocolate') then return Color3.fromRGB(139,69,19)
    elseif fullText:find('pollinated') then return Color3.fromRGB(255,255,0)
    elseif fullText:find('frozen') then return Color3.fromRGB(173,216,230)
    else return Color3.fromRGB(170, 0, 255) end
end

local function createESP(model, displayText)
    local color = getColorFromModel(model, displayText)
    local highlight = Instance.new('Highlight')
    highlight.Name = 'BrainrotESPHighlight'
    highlight.Adornee = model
    highlight.FillTransparency = 0.6
    highlight.OutlineTransparency = 0
    if color ~= 'rainbow' then
        highlight.FillColor = color
        highlight.OutlineColor = color
    end
    highlight.Parent = Workspace

    local part = model.PrimaryPart or model:FindFirstChildWhichIsA('BasePart')
    if not part then return highlight, nil, nil end

    local tag = Instance.new('BillboardGui')
    tag.Name = 'BrainrotESPTag'
    tag.Size = UDim2.new(0, 200, 0, 50)
    tag.AlwaysOnTop = true
    tag.StudsOffset = Vector3.new(0, 8, 0)
    tag.Adornee = part
    tag.Parent = Workspace

    local label = Instance.new('TextLabel')
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = displayText or model.Name
    label.TextStrokeTransparency = 0.5
    label.TextScaled = true
    label.Font = Enum.Font.GothamBold
    label.TextColor3 = (color == 'rainbow') and getRainbowColor() or color
    label.Parent = tag

    return highlight, tag, label
end

local function isMyPlot(plot)
    local sign = plot:FindFirstChild("PlotSign")
    return sign and sign:FindFirstChild("YourBase") and sign.YourBase.Enabled
end

local function getBestBrainrots()
    local maxValue = -1
    local bestLabel = nil
    if not Workspace:FindFirstChild('Plots') then return {} end

    for _, plot in pairs(Workspace.Plots:GetChildren()) do
        if isMyPlot(plot) then continue end

        for _, obj in pairs(plot:GetDescendants()) do
            if obj:IsA('TextLabel') then
                local txt = obj.Text or ''
                if txt:find('/') and txt:lower():find('s') then
                    local val = parseNumber(txt)
                    if val and val > maxValue then
                        maxValue = val
                        bestLabel = obj
                    end
                end
            end
        end
    end

    local results = {}
    if bestLabel then
        local model = bestLabel:FindFirstAncestorOfClass('Model')
        if model then table.insert(results, {model, bestLabel.Text}) end
    end
    return results
end

local function clearESP(model)
    local esp = activeBestBrainrotESPs[model]
    if esp then
        for _, obj in pairs(esp) do
            if typeof(obj) == "Instance" then obj:Destroy() end
        end
        activeBestBrainrotESPs[model] = nil
    end
end

local function startBrainrotEsp()
    if brainrotEspEnabled then return end
    brainrotEspEnabled = true

    task.spawn(function()
        while brainrotEspEnabled do
            local bestModels = getBestBrainrots()
            local newSet = {}

            for _, data in ipairs(bestModels) do
                local model, labelText = data[1], data[2]
                if model and model.Parent then
                    newSet[model] = true

                    if not activeBestBrainrotESPs[model] then
                        local highlight, tag, label = createESP(model, labelText)
                        activeBestBrainrotESPs[model] = {highlight, tag, label}
                    else
                        activeBestBrainrotESPs[model][3].Text = labelText
                    end
                end
            end

            for model in pairs(activeBestBrainrotESPs) do
                if not newSet[model] then
                    clearESP(model)
                end
            end

            task.wait(3)
        end
    end)
end

local function stopBrainrotEsp()
    brainrotEspEnabled = false
    for model in pairs(activeBestBrainrotESPs) do
        clearESP(model)
    end
end

-- ======= Section: Player ESP ======= --
local playerEspEnabled = false
local playerEspConnections = {}
local ESP_NAME = "NyoaEsp_3D_BOX"

local function clear(char)
    for _, v in ipairs(char:GetChildren()) do
        if v.Name == ESP_NAME then v:Destroy() end
    end
end

local function createBox(char)
    if not char:FindFirstChild("HumanoidRootPart") then return end
    local hrp = char.HumanoidRootPart

    local box = Instance.new("BoxHandleAdornment")
    box.Name = ESP_NAME
    box.Adornee = hrp
    box.Size = Vector3.new(4.2, 6.2, 2.4)
    box.Color3 = Color3.fromRGB(255, 255, 255)
    box.Transparency = 0.45
    box.AlwaysOnTop = true
    box.ZIndex = 10
    box.Parent = char
end

local function setup(player)
    if player == Player then return end

    local function onChar(char)
        clear(char)
        createBox(char)
    end

    if player.Character then onChar(player.Character) end

    local conn = player.CharacterAdded:Connect(onChar)
    table.insert(playerEspConnections, conn)
end

local function enablePlayerEsp()
    if playerEspEnabled then return end
    playerEspEnabled = true

    for _, p in ipairs(Players:GetPlayers()) do
        setup(p)
    end

    table.insert(playerEspConnections, Players.PlayerAdded:Connect(setup))
end

local function disablePlayerEsp()
    if not playerEspEnabled then return end
    playerEspEnabled = false

    for _, p in ipairs(Players:GetPlayers()) do
        if p.Character then clear(p.Character) end
    end

    for _, conn in ipairs(playerEspConnections) do conn:Disconnect() end
    playerEspConnections = {}
end

-- ======= Section: Best Price ESP ======= --
local bestPriceEspEnabled = false

local function StartBestPriceESP()
    if bestPriceEspEnabled then return end
    bestPriceEspEnabled = true

    pcall(function()
        local LocalPlayer = Players.LocalPlayer
        local PlotController = require(ReplicatedStorage.Controllers.PlotController)
        require(ReplicatedStorage.Datas.Animals)
        local AnimalsShared = require(ReplicatedStorage.Shared.Animals)

        local GREEN = Color3.fromRGB(0,255,0)

        local State = {
            highlights = {},
            guis = {},
            beams = {},
            CHECK_DELAY = 2,
            excludeOwnBase = true,
            enabled = true
        }

        local function Clear()
            for _,v in pairs(State.highlights) do if v and v.Parent then v:Destroy() end end
            for _,v in pairs(State.guis) do if v and v.Parent then v:Destroy() end end
            for _,v in pairs(State.beams) do if v and v.Parent then v:Destroy() end end
            table.clear(State.highlights)
            table.clear(State.guis)
            table.clear(State.beams)
        end

        local function FormatPrice(v)
            if v >= 1e9 then return math.floor(v/1e9).."B"
            elseif v >= 1e6 then return math.floor(v/1e6).."M"
            elseif v >= 1e3 then return math.floor(v/1e3).."K"
            else return tostring(math.floor(v)) end
        end

        local function AddHighlight(podium)
            local h = Instance.new("Highlight")
            h.FillColor = GREEN
            h.OutlineColor = GREEN
            h.FillTransparency = 0
            h.OutlineTransparency = 0
            h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
            h.Parent = podium
            table.insert(State.highlights, h)
        end

        local function AddBeam(podium)
            local part = podium:FindFirstChildWhichIsA("BasePart", true)
            if not part then return end

            local beam = Instance.new("Beam")
            beam.FaceCamera = true
            beam.Width0 = 0.7
            beam.Width1 = 0.7
            beam.Color = ColorSequence.new(GREEN)
            beam.Transparency = NumberSequence.new(0)
            beam.Parent = Workspace

            local a0 = Instance.new("Attachment")
            a0.Parent = Workspace.Terrain

            local a1 = Instance.new("Attachment")
            a1.Parent = part

            beam.Attachment0 = a0
            beam.Attachment1 = a1

            RunService.Heartbeat:Connect(function()
                local char = LocalPlayer.Character
                if char and char:FindFirstChild("Head") then
                    a0.Position = char.Head.Position
                end
            end)

            table.insert(State.beams, beam)
        end

        local function AddBillboard(podium, price)
            local part = podium:FindFirstChildWhichIsA("BasePart", true)
            if not part then return end

            local bb = Instance.new("BillboardGui")
            bb.Adornee = part
            bb.AlwaysOnTop = true
            bb.Size = UDim2.new(0,120,0,30)
            bb.StudsOffset = Vector3.new(0,6,0)
            bb.Parent = Workspace

            local tl = Instance.new("TextLabel")
            tl.Size = UDim2.new(1,0,1,0)
            tl.BackgroundTransparency = 1
            tl.TextScaled = true
            tl.Font = Enum.Font.GothamBold
            tl.TextStrokeTransparency = 0.4
            tl.RichText = true
            tl.Text = "<font color='#00FF00'>$"..FormatPrice(price).."</font>"
            tl.Parent = bb

            table.insert(State.guis, bb)
        end

        local function GetPlots()
            if not getgenv()._plots then
                getgenv()._plots = getupvalue(PlotController.Start,2)
            end
            return getgenv()._plots
        end

        local function GetPlotAnimals(plot)
            local _, data = (plot or PlotController:GetMyPlot()).Channel:Get("AnimalList")
            return data.AnimalList
        end

        local function GetAnimalPrice(index)
            return AnimalsShared:GetPrice(index)
        end

        task.spawn(function()
            while State.enabled do
                Clear()

                local bestPrice = -math.huge
                local bestAnimal

                for _, plot in pairs(GetPlots()) do
                    if not State.excludeOwnBase or plot.UID ~= PlotController:GetMyPlot().UID then
                        local animals = GetPlotAnimals(plot)
                        if animals then
                            for idx, data in pairs(animals) do
                                if data ~= "Empty" and data.Steal == false then
                                    local price = GetAnimalPrice(data.Index)
                                    if price and price > bestPrice then
                                        bestPrice = price
                                        bestAnimal = {plotUID = plot.UID, index = idx, price = price}
                                    end
                                end
                            end
                        end
                    end
                end

                if bestAnimal then
                    local ok, podium = pcall(function()
                        return Workspace.Plots[bestAnimal.plotUID].AnimalPodiums[bestAnimal.index]
                    end)
                    if ok and podium then
                        AddHighlight(podium)
                        AddBeam(podium)
                        AddBillboard(podium, bestAnimal.price)
                    end
                end

                task.wait(State.CHECK_DELAY)
            end
        end)
    end)
end

local function StopBestPriceESP()
    bestPriceEspEnabled = false
end

-- ======= Section: Movement Features (start/stop) ======= --
local function startFloat()
    local char = Player.Character or Player.CharacterAdded:Wait()
    local root = char:WaitForChild("HumanoidRootPart")
    local hum = char:WaitForChild("Humanoid")

    local floatPart = Instance.new("Part")
    floatPart.Size = Vector3.new(4, 1, 4)
    floatPart.Transparency = 1
    floatPart.CanCollide = false
    floatPart.Anchored = false
    floatPart.Massless = true
    floatPart.Parent = Workspace

    local weld = Instance.new("Weld")
    weld.Part0 = root
    weld.Part1 = floatPart
    weld.C0 = CFrame.new(0, -3.5, 0)
    weld.Parent = floatPart

    local bodyVel = Instance.new("BodyVelocity")
    bodyVel.MaxForce = Vector3.new(0, 99999, 0)
    bodyVel.P = 3000
    bodyVel.Velocity = Vector3.new(0, 0, 0)
    bodyVel.Parent = floatPart

    local con = RunService.Stepped:Connect(function()
        if hum.Health <= 0 then return end
        local state = hum:GetState()
        local inAir = state == Enum.HumanoidStateType.Freefall or state == Enum.HumanoidStateType.FallingDown or state == Enum.HumanoidStateType.Jumping
        local ray = Workspace:Raycast(root.Position, Vector3.new(0, -5, 0))
        local onGround = ray ~= nil
        if inAir or not onGround then
            bodyVel.Velocity = Vector3.new(0, -3.2, 0)
        else
            bodyVel.Velocity = Vector3.new(0, 0, 0)
        end
    end)

    Player.CharacterAdded:Connect(function()
        task.wait(1)
        if Config.Float then startFloat() end
    end)
end

local function stopFloat()
    -- Window close will call this
end

local function startNyoaFly()
    local conn
    conn = RunService.Heartbeat:Connect(function()
        local hrp = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
        if hrp then
            hrp.Velocity = Workspace.CurrentCamera.CFrame.LookVector * 28.5
        end
    end)
    Player.CharacterAdded:Connect(function()
        task.wait(0.3)
        if conn then conn:Disconnect() end
        if Config.NyoaFly then startNyoaFly() end
    end)
    Player.CharacterRemoving:Connect(function()
        if conn then conn:Disconnect() end
    end)
end

local function stopNyoaFly()
    local hrp = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
    if hrp then hrp.Velocity = Vector3.zero end
end

local function startNyoaBoost()
    local conn
    conn = RunService.Heartbeat:Connect(function()
        local hrp = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        local direction = Workspace.CurrentCamera.CFrame.LookVector * Vector3.new(1,0,1)
        if direction.Magnitude > 0 then
            direction = direction.Unit
            hrp.Velocity = Vector3.new(direction.X * 28.5, hrp.Velocity.Y, direction.Z * 28.5)
        end
    end)
    Player.CharacterAdded:Connect(function()
        task.wait(0.3)
        if conn then conn:Disconnect() end
        if Config.NyoaBoost then startNyoaBoost() end
    end)
end

local function stopNyoaBoost()
    local hrp = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
    if hrp then hrp.Velocity = Vector3.new(0, hrp.Velocity.Y, 0) end
end

local function startNyoaFlyGrapple()
    local item = "Grapple Hook"
    local useRE = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RE/UseItem")
    local args = {0.10267777442932129}

    local function buy() pcall(function() ReplicatedStorage.Packages.Net["RF/CoinsShopService/RequestBuy"]:InvokeServer(item) end) end
    local function equip() if Player.Character then local t = Player.Character:FindFirstChild(item) or Player.Backpack:FindFirstChild(item) if t then t.Parent = Player.Character end end end
    local function fake() if Player.Character and Player.Character:FindFirstChild(item) then pcall(function() useRE:FireServer(unpack(args)) end) end end

    buy()
    task.wait(0.5)
    equip()

    local conn
    conn = RunService.Heartbeat:Connect(function()
        local hrp = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
        if hrp then
            fake()
            hrp.Velocity = Workspace.CurrentCamera.CFrame.LookVector * 130
        end
    end)
    Player.CharacterAdded:Connect(function()
        task.wait(1)
        if Config.NyoaFlyGrapple then startNyoaFlyGrapple() end
    end)
end

local function stopNyoaFlyGrapple()
    local hrp = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
    if hrp then hrp.Velocity = Vector3.zero end
end

local function startInfiniteJump()
    local jumpConnection
    local lastJumpTime = 0
    local jumpCooldown = 0.1

    jumpConnection = UserInputService.JumpRequest:Connect(function()
        local hum = Player.Character and Player.Character:FindFirstChildOfClass("Humanoid")
        local root = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
        if not hum or not root then return end

        if tick() - lastJumpTime < jumpCooldown then return end

        local state = hum:GetState()
        if state == Enum.HumanoidStateType.Freefall or state == Enum.HumanoidStateType.Running or state == Enum.HumanoidStateType.Jumping then
            root.Velocity = Vector3.new(root.Velocity.X, 52, root.Velocity.Z)
            lastJumpTime = tick()
        end
    end)
end

local function stopInfiniteJump()
    -- No specific cleanup needed
end

local function startAntiEffects()
    local cleanLoop = nil
    local fovConn = nil

    local function cleanEffects()
        if Workspace.CurrentCamera.FieldOfView ~= 70 then
            Workspace.CurrentCamera.FieldOfView = 70
        end

        for _, effect in ipairs(game.Lighting:GetChildren()) do
            if effect:IsA("BlurEffect") or effect:IsA("PostEffect") or effect.Name:lower():find("bee") or effect.Name:lower():find("colorcorrection") then
                pcall(function() effect:Destroy() end)
            end
        end
    end

    cleanEffects()
    Workspace.CurrentCamera.FieldOfView = 70

    cleanLoop = task.spawn(function()
        while Config.AntiEffects do
            task.wait(0.5)
            cleanEffects()
        end
    end)

    fovConn = Workspace.CurrentCamera:GetPropertyChangedSignal("FieldOfView"):Connect(function()
        if Config.AntiEffects then
            Workspace.CurrentCamera.FieldOfView = 70
        end
    end)
end

local function stopAntiEffects()
    -- Loop stops automatically
end

local function startAutoSteal()
    local function stealAll()
        local character = Player.Character or Player.CharacterAdded:Wait()
        if not character or not character:FindFirstChild("HumanoidRootPart") then return end
        local myPos = character.HumanoidRootPart.Position

        local closestPrompt = nil
        local closestDist = math.huge

        for _, obj in ipairs(Workspace:GetDescendants()) do
            if obj:IsA("ProximityPrompt") and obj.ActionText == "Steal" and obj.ObjectText ~= nil then
                local attachment = obj.Parent
                if attachment and attachment:IsA("Attachment") then
                    local dist = (myPos - attachment.WorldPosition).Magnitude
                    if dist <= 20 and dist < closestDist then
                        closestDist = dist
                        closestPrompt = obj
                    end
                end
            end
        end

        if closestPrompt then
            closestPrompt:InputHoldBegin()
        end
    end

    task.spawn(function()
        while Config.AutoSteal do
            pcall(stealAll)
            task.wait(0.2)
        end
    end)
end

local function stopAutoSteal()
    -- Loop stops automatically
end

local function startInvisible()
    toggleInvisible(true)
end

local function stopInvisible()
    toggleInvisible(false)
end

local function startSemiInvisible()
    toggleSemiInvisible(true)
end

local function stopSemiInvisible()
    toggleSemiInvisible(false)
end

-- ======= Section: Combat Features ======= --
local AntiRagdoll_Enabled = false
local RagdollConnections = {}

local function EnableAntiRagdoll()
    if AntiRagdoll_Enabled then return end
    AntiRagdoll_Enabled = true

    local char = Player.Character or Player.CharacterAdded:Wait()
    local hum = char:WaitForChild("Humanoid")
    local root = char:WaitForChild("HumanoidRootPart")

    for _, mod in ipairs(getloadedmodules()) do
        if mod.Name:lower():find("ragdoll") then
            local success, controller = pcall(require, mod)
            if success and type(controller) == "table" then
                if isreadonly(controller) then setreadonly(controller, false) end
                controller.Start = function() end
                controller.IsInRagdoll = function() return false end
                controller.ToggleControls = function() end
                setreadonly(controller, true)
            end
        end
    end

    local pkg = ReplicatedStorage:FindFirstChild("Packages")
    if pkg then
        local rag = pkg:FindFirstChild("Ragdoll")
        if rag then
            local remote = rag:FindFirstChild("Ragdoll")
            if remote then
                RagdollConnections.remote = remote.OnClientEvent:Connect(function() end)
            end
        end
    end

    RagdollConnections.heartbeat = RunService.Heartbeat:Connect(function()
        pcall(function()
            if hum:GetState() == Enum.HumanoidStateType.Physics then
                hum:ChangeState(Enum.HumanoidStateType.GettingUp)
            end
            Workspace.CurrentCamera.CameraSubject = hum
            root.CanCollide = true
        end)
    end)

    RagdollConnections.descendant = char.DescendantAdded:Connect(function(obj)
        if obj:IsA("BallSocketConstraint") or obj:IsA("HingeConstraint") or obj:IsA("NoCollisionConstraint") then
            obj:Destroy()
        end
    end)

    RagdollConnections.charAdded = Player.CharacterAdded:Connect(function(newChar)
        char = newChar
        hum = newChar:WaitForChild("Humanoid")
        root = newChar:WaitForChild("HumanoidRootPart")
    end)
end

local function DisableAntiRagdoll()
    if not AntiRagdoll_Enabled then return end
    AntiRagdoll_Enabled = false
    for _, conn in pairs(RagdollConnections) do
        if typeof(conn) == "RBXScriptConnection" then
            conn:Disconnect()
        end
    end
    RagdollConnections = {}
end

local AntiKnockback_Enabled = false
local AntiKnockbackConnections = {}

local function EnableAntiKnockback()
    if AntiKnockback_Enabled then return end
    AntiKnockback_Enabled = true

    local Character = Player.Character or Player.CharacterAdded:Wait()
    local Humanoid = Character:WaitForChild("Humanoid")

    Humanoid.BreakJointsOnDeath = false

    for _, Part in pairs(Character:GetDescendants()) do
        if Part:IsA("BasePart") then
            Part.CanCollide = false
            Part.Massless = false
            Part.Touched:Connect(function() end)
        end
    end

    AntiKnockbackConnections.Knockback = RunService.Stepped:Connect(function()
        if not AntiKnockback_Enabled then return end
        local root = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
        if not root then return end

        for _, Obj in pairs(root:GetChildren()) do
            if Obj:IsA("BodyVelocity") or Obj:IsA("BodyMover") or Obj:IsA("VectorForce") then
                Obj:Destroy()
            end
        end

        local Vel = root.Velocity
        local Move = Humanoid.MoveDirection * Humanoid.WalkSpeed
        root.Velocity = Vector3.new(Move.X, Vel.Y, Move.Z)
    end)

    AntiKnockbackConnections.Respawn = Player.CharacterAdded:Connect(function(Ch)
        task.wait()
        for _, Part in pairs(Ch:GetDescendants()) do
            if Part:IsA("BasePart") then
                Part.CanCollide = false
                Part.Massless = false
            end
        end
    end)
end

local function DisableAntiKnockback()
    AntiKnockback_Enabled = false

    for _, Conn in pairs(AntiKnockbackConnections) do
        if Conn.Connected then
            Conn:Disconnect()
        end
    end
    AntiKnockbackConnections = {}

    local Char = Player.Character
    if Char then
        for _, Part in pairs(Char:GetDescendants()) do
            if Part:IsA("BasePart") then
                Part.CanCollide = true
            end
        end
    end
end

-- ======= Section: Misc Features ======= --
local KickAfterSteal = false
local oldFire

local targetRemote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RE/5c8f0dd0-0f9e-44ba-8f9b-197958b661ab")

local function enableKickAfterSteal()
    if KickAfterSteal then return end
    KickAfterSteal = true

    oldFire = hookfunction(targetRemote.FireServer, function(self, ...)
        local args = {...}
        if args[1] == "7799aa8a-03f9-4df1-ab0f-b6df84f6b36c" then
            task.spawn(function()
                task.wait(1)
                Player:Kick("You stole a brainrot")
            end)
        end
        return oldFire(self, ...)
    end)
end

local function disableKickAfterSteal()
    if not KickAfterSteal then return end
    KickAfterSteal = false
    if oldFire then
        hookfunction(targetRemote.FireServer, oldFire)
    end
end

local FriendsAllowed_Enabled = false
local friendsRemote = ReplicatedStorage.Packages.Net["RE/PlotService/ToggleFriends"]

local function toggleFriends(state)
    FriendsAllowed_Enabled = state
    friendsRemote:FireServer()
end

local DeleteParts_Enabled = false

local function startDeleteParts()
    if DeleteParts_Enabled then return end
    DeleteParts_Enabled = true
    task.spawn(function()
        while DeleteParts_Enabled do
            for _,v in Workspace:GetDescendants() do
                if v:IsA("BasePart") and not v.Anchored and v.Parent ~= Player.Character and not v.Parent:FindFirstChild("Humanoid") then
                    v:Destroy()
                end
            end
            task.wait(2)
        end
    end)
end

local function stopDeleteParts()
    DeleteParts_Enabled = false
end

local function toggleInvisible(state)
    local char = Player.Character or Player.CharacterAdded:Wait()
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not humanoid or not hrp then return end

    if state then
        local camCFrame = Workspace.CurrentCamera.CFrame
        Workspace.CurrentCamera.CameraType = Enum.CameraType.Scriptable
        Workspace.CurrentCamera.CFrame = camCFrame
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") then part.CanCollide = false end
        end
        char:PivotTo(hrp.CFrame - Vector3.new(0,70,0))
        task.wait(0.1)
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") then part.Anchored = true end
        end
        humanoid.PlatformStand = true
        task.wait(1.5)
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") then part.Anchored = false end
        end
        humanoid.PlatformStand = false
        char:PivotTo(hrp.CFrame - Vector3.new(0,70,0))
        task.wait(0.1)
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") then part.Anchored = true end
        end
        humanoid.PlatformStand = true
        Workspace.CurrentCamera.CameraType = Enum.CameraType.Custom
    else
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") then part.Anchored = false part.CanCollide = true end
        end
        humanoid.PlatformStand = false
        Workspace.CurrentCamera.CameraType = Enum.CameraType.Custom
    end
end

local semiConnections = {}

local function toggleSemiInvisible(state)
    local function removeFolders()
        local playerFolder = Workspace:FindFirstChild(Player.Name)
        if playerFolder then
            if playerFolder:FindFirstChild("DoubleRig") then playerFolder.DoubleRig:Destroy() end
            if playerFolder:FindFirstChild("Constraints") then playerFolder.Constraints:Destroy() end
        end
    end

    local function doClone()
        local char = Player.Character
        if not char or not char:FindFirstChild("Humanoid") or char.Humanoid.Health <= 0 then return false end
        local oldRoot = char:FindFirstChild("HumanoidRootPart")
        if not oldRoot then return false end
        local tempParent = Instance.new("Model")
        char.Parent = tempParent
        local clone = oldRoot:Clone()
        clone.Parent = char
        oldRoot.Parent = Workspace.CurrentCamera
        clone.CFrame = oldRoot.CFrame
        char.PrimaryPart = clone
        char.Parent = Workspace
        for _, v in pairs(char:GetDescendants()) do
            if v:IsA("Weld") or v:IsA("Motor6D") then
                if v.Part0 == oldRoot then v.Part0 = clone end
                if v.Part1 == oldRoot then v.Part1 = clone end
            end
        end
        tempParent:Destroy()
        return true, oldRoot, clone
    end

    local function animationTrickery()
        local char = Player.Character
        if not char or not char:FindFirstChild("Humanoid") then return end
        local anim = Instance.new("Animation")
        anim.AnimationId = "http://www.roblox.com/asset/?id=18537363391"
        local animator = char.Humanoid:FindFirstChild("Animator") or Instance.new("Animator", char.Humanoid)
        local track = animator:LoadAnimation(anim)
        track.Priority = Enum.AnimationPriority.Action4
        track:Play(0,1,0)
        anim:Destroy()
        track.TimePosition = 0.7
        task.delay(1, function() track:AdjustSpeed(math.huge) end)
    end

    if state then
        removeFolders()
        local success, oldRoot, clone = doClone()
        if success then
            animationTrickery()
            local conn = RunService.PreSimulation:Connect(function()
                local root = Player.Character and Player.Character.PrimaryPart
                if root and oldRoot then
                    local cf = root.CFrame - Vector3.new(0, Player.Character.Humanoid.HipHeight + (root.Size.Y/2) - 1 + 0.09, 0)
                    oldRoot.CFrame = cf * CFrame.Angles(math.rad(180),0,0)
                    oldRoot.Velocity = root.Velocity
                    oldRoot.CanCollide = false
                end
            end)
            table.insert(semiConnections, conn)
        end
    else
        for _, conn in ipairs(semiConnections) do if conn.Connected then conn:Disconnect() end end
        semiConnections = {}
    end
end

-- ======= Section: Main Menu GUI ======= --
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "NyoaSs"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.Parent = pgui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0,420,0,300)
mainFrame.Position = UDim2.new(0.5,-210,0.5,-150)
mainFrame.BackgroundColor3 = Color3.fromRGB(18,18,22)
mainFrame.ClipsDescendants = true
mainFrame.Parent = screenGui
Instance.new("UICorner",mainFrame).CornerRadius = UDim.new(0,10)
local mstroke = Instance.new("UIStroke",mainFrame)
mstroke.Color = Color3.new(1,1,1)
mstroke.Transparency = 0.85
mstroke.Thickness = 1

local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1,0,0,44)
titleBar.BackgroundColor3 = Color3.fromRGB(22,22,26)
titleBar.Parent = mainFrame
Instance.new("UICorner",titleBar).CornerRadius = UDim.new(0,10)

Drag(mainFrame, titleBar)

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(0,300,1,0)
titleLabel.Position = UDim2.new(0,16,0,0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "NyoaSs | discord.gg/WBYkWfPQC2"
titleLabel.TextColor3 = Color3.fromRGB(240,240,245)
titleLabel.Font = Enum.Font.GothamMedium
titleLabel.TextSize = 15
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Parent = titleBar

local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0,40,0,40)
closeBtn.Position = UDim2.new(1,-44,0,2)
closeBtn.BackgroundTransparency = 1
closeBtn.Text = "x"
closeBtn.TextColor3 = Color3.fromRGB(255,100,100)
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 26
closeBtn.Parent = titleBar

local minimizeBtn = Instance.new("TextButton")
minimizeBtn.Size = UDim2.new(0,40,0,40)
minimizeBtn.Position = UDim2.new(1,-84,0,2)
minimizeBtn.BackgroundTransparency = 1
minimizeBtn.Text = "-"
minimizeBtn.TextColor3 = Color3.fromRGB(200,200,200)
minimizeBtn.Font = Enum.Font.Gotham
minimizeBtn.TextSize = 30
minimizeBtn.Parent = titleBar

local contentContainer = Instance.new("Frame")
contentContainer.Size = UDim2.new(1,0,1,-44)
contentContainer.Position = UDim2.new(0,0,0,44)
contentContainer.BackgroundTransparency = 1
contentContainer.ClipsDescendants = true
contentContainer.Parent = mainFrame

local tabContainer = Instance.new("Frame")
tabContainer.Size = UDim2.new(1,-20,0,46)
tabContainer.Position = UDim2.new(0,10,0,2)
tabContainer.BackgroundTransparency = 1
tabContainer.Parent = contentContainer

local contentArea = Instance.new("ScrollingFrame")
contentArea.Size = UDim2.new(1, -20, 1, -56)
contentArea.Position = UDim2.new(0, 10, 0, 50)
contentArea.BackgroundTransparency = 1
contentArea.ScrollBarThickness = 6
contentArea.ScrollBarImageColor3 = Color3.fromRGB(100, 180, 255)
contentArea.ScrollingDirection = Enum.ScrollingDirection.Y
contentArea.Parent = contentContainer

contentArea.AutomaticCanvasSize = Enum.AutomaticSize.Y
contentArea.CanvasSize = UDim2.new(0, 0, 0, 0)

local pages = {
    Combat = Instance.new("Frame"),
    Visual = Instance.new("Frame"),
    Perform = Instance.new("Frame"),
    Misc = Instance.new("Frame"),
    Movement = Instance.new("Frame"),
    Setting = Instance.new("Frame")
}

for _, page in pairs(pages) do
    page.Size = UDim2.new(1,0,0,0)
    page.BackgroundTransparency = 1
    page.AutomaticSize = Enum.AutomaticSize.Y
    page.Visible = false
    page.Parent = contentArea

    local layout = Instance.new("UIListLayout")
    layout.Padding = UDim.new(0,8)
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.Parent = page
end

pages.Combat.Visible = true

local tabOrder = {"Combat", "Visual", "Perform", "Misc", "Movement", "Setting"}
local tabButtons = {}

for i, name in ipairs(tabOrder) do
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0,70,1,0)
    btn.Position = UDim2.new(0,(i-1)*70,0,0)
    btn.BackgroundTransparency = 1
    btn.Text = name
    btn.TextColor3 = i==1 and Color3.new(1,1,1) or Color3.fromRGB(140,140,150)
    btn.Font = Enum.Font.GothamMedium
    btn.TextSize = 14
    btn.Parent = tabContainer

    local ind = Instance.new("Frame")
    ind.Size = UDim2.new(0,54,0,2)
    ind.Position = UDim2.new(0.5,-27,1,-2)
    ind.BackgroundColor3 = Color3.new(1,1,1)
    ind.Visible = i==1
    ind.Parent = btn

    tabButtons[name] = {Button = btn, Indicator = ind}

    btn.MouseButton1Click:Connect(function()
        for _, tab in pairs(tabButtons) do
            tab.Button.TextColor3 = Color3.fromRGB(140,140,150)
            tab.Indicator.Visible = false
        end

        btn.TextColor3 = Color3.new(1,1,1)
        ind.Visible = true

        for _, page in pairs(pages) do
            page.Visible = false
        end
        pages[name].Visible = true
    end)
end

local function createToggle(parent, text, key, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, -20, 0, 40)
    frame.BackgroundTransparency = 1
    frame.Parent = parent

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1,-70,1,0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(200,200,200)
    label.Font = Enum.Font.Gotham
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame

    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0,52,0,26)
    btn.Position = UDim2.new(1,-62,0.5,-13)
    btn.BackgroundColor3 = Color3.fromRGB(60,60,65)
    btn.Text = ""
    btn.AutoButtonColor = false
    btn.Parent = frame
    Instance.new("UICorner",btn).CornerRadius = UDim.new(0,13)

    local circle = Instance.new("Frame")
    circle.Size = UDim2.new(0,20,0,20)
    circle.Position = UDim2.new(0,4,0.5,-10)
    circle.BackgroundColor3 = Color3.fromRGB(180,180,180)
    circle.Parent = btn
    Instance.new("UICorner",circle).CornerRadius = UDim.new(1,0)

    local state = Config[key] or false
    btn.MouseButton1Click:Connect(function()
        state = not state
        Config[key] = state
        btn.BackgroundColor3 = state and Color3.fromRGB(100,180,255) or Color3.fromRGB(60,60,65)
        TweenService:Create(circle,TweenInfo.new(0.2),{Position = state and UDim2.new(0,28,0.5,-10) or UDim2.new(0,4,0.5,-10)}):Play()
        if callback then callback(state) end
    end)

    btn.BackgroundColor3 = state and Color3.fromRGB(100,180,255) or Color3.fromRGB(60,60,65)
    circle.Position = state and UDim2.new(0,28,0.5,-10) or UDim2.new(0,4,0.5,-10)
    if callback then callback(state) end
end

local function createButton(parent, text, callback)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, -20, 0, 40)
    frame.BackgroundTransparency = 1
    frame.Parent = parent

    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1,0,1,0)
    btn.BackgroundColor3 = Color3.fromRGB(70,130,180)
    btn.Text = text
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 15
    btn.Parent = frame
    Instance.new("UICorner",btn).CornerRadius = UDim.new(0,8)
    btn.MouseButton1Click:Connect(callback)
end

-- ======= Section: Toggles ======= --
createToggle(pages.Visual, "Xray", "Xray", function(state)
    if state then
        XrayOn(obj)
        if xrayConnection then xrayConnection:Disconnect() end
        xrayConnection = RunService.Heartbeat:Connect(function()
            XrayOn(obj)
        end)
    else
        XrayOff(obj)
        if xrayConnection then xrayConnection:Disconnect() xrayConnection = nil end
    end
end)

createToggle(pages.Visual, "Base ESP", "BaseESP", function(state)
    if state then
        for _,p in obj:GetChildren() do if p:IsA("Model") then CreatePlotESP(p) end end
        obj.ChildAdded:Connect(function(p) task.wait(0.5) if p:IsA("Model") then CreatePlotESP(p) end end)
        obj.ChildRemoved:Connect(RemovePlotESP)
    else
        for p,_ in PlotESP_Data do RemovePlotESP(p) end
    end
end)

createToggle(pages.Visual, "Plot Timer", "PlotTimer", function(state)
    if state then
        for _,p in obj:GetChildren() do if p:IsA("Model") then CreateTimeESP(p) end end
        obj.ChildAdded:Connect(function(p) task.wait(0.5) if p:IsA("Model") then CreateTimeESP(p) end end)
        obj.ChildRemoved:Connect(RemoveTimeESP)
    else
        for p,_ in PlotTimeESP_Data do RemoveTimeESP(p) end
    end
end)

createToggle(pages.Visual, "Best Value ESP", "BestValueESP", function(state)
    if state then startBrainrotEsp() else stopBrainrotEsp() end
end)

createToggle(pages.Visual, "Best Price ESP", "BestPriceESP", function(state)
    if state then StartBestPriceESP() else StopBestPriceESP() end
end)

createToggle(pages.Visual, "Player ESP", "PlayerESP", function(state)
    if state then enablePlayerEsp() else disablePlayerEsp() end
end)

createToggle(pages.Movement, "NyoaSs Fly", "NyoaFly", function(state)
    if state then CreateFeatureWindow("Fly", "NyoaSs Fly", startNyoaFly, stopNyoaFly, "NyoaFly") end
end)

createToggle(pages.Movement, "Nyoa.Ss Boost", "NyoaBoost", function(state)
    if state then CreateFeatureWindow("Boost", "Nyoa.Ss Boost", startNyoaBoost, stopNyoaBoost, "NyoaBoost") end
end)

createToggle(pages.Movement, "Float", "Float", function(state)
    if state then CreateFeatureWindow("Float", "Float", startFloat, stopFloat, "Float") end
end)

createToggle(pages.Movement, "NyoaSS Grapple Fly", "NyoaFlyGrapple", function(state)
    if state then CreateFeatureWindow("Grapple", "NyoaSS Grapple Fly", startNyoaFlyGrapple, stopNyoaFlyGrapple, "NyoaFlyGrapple") end
end)

createToggle(pages.Movement, "Infinite Jump", "InfiniteJump", function(state)
    if state then CreateFeatureWindow("InfiniteJump", "Infinite Jump", startInfiniteJump, stopInfiniteJump, "InfiniteJump") end
end)

createToggle(pages.Misc, "Invisible", "Invisible", function(state)
    if state then CreateFeatureWindow("Invisible", "Invisible", startInvisible, stopInvisible, "Invisible") end
end)

createToggle(pages.Misc, "Semi Invisible", "SemiInvisible", function(state)
    if state then CreateFeatureWindow("SemiInvisible", "Semi Invisible", startSemiInvisible, stopSemiInvisible, "SemiInvisible") end
end)

createToggle(pages.Misc, "Auto Steal", "AutoSteal", function(state)
    if state then CreateFeatureWindow("AutoSteal", "Nearest Auto Steal", startAutoSteal, stopAutoSteal, "AutoSteal") end
end)

createToggle(pages.Perform, "Anti Effects", "AntiEffects", function(state)
    if state then CreateFeatureWindow("AntiEffects", "Anti Effects", startAntiEffects, stopAntiEffects, "AntiEffects") end
end)

createToggle(pages.Combat, "Anti Ragdoll", "AntiRagdoll", function(state)
    if state then EnableAntiRagdoll() else DisableAntiRagdoll() end
end)

createToggle(pages.Combat, "Anti Knockback", "AntiKnockback", function(state)
    if state then EnableAntiKnockback() else DisableAntiKnockback() end
end)

createToggle(pages.Misc, "Friends Allowed", "FriendsAllowed", function(state)
    toggleFriends(state)
end)

createToggle(pages.Misc, "Kick After Steal", "KickAfterSteal", function(state)
    if state then enableKickAfterSteal() else disableKickAfterSteal() end
end)

createToggle(pages.Perform, "Delete Parts", "DeleteParts", function(state)
    if state then startDeleteParts() else stopDeleteParts() end
end)

createButton(pages.Setting, "Save Config", saveConfig)

createButton(pages.Setting, "Reset Config", function()
    Config = DEFAULT_CONFIG
    saveConfig()
    createNotify("Config reset!")
end)

createButton(pages.Setting, "Nyoa Helper", function()
    loadstring(game:HttpGet("https://pastefy.app/MItLJzDI/raw"))()
end)

-- ======= Section: Closing & Startup ======= --
closeBtn.MouseButton1Click:Connect(function()
    mainFrame.Visible = false
    createNotify("NyoaSs Unloading, Please wait :/")
    task.wait(6.3)
    screenGui:Destroy()
end)

local minimized = false
minimizeBtn.MouseButton1Click:Connect(function()
    minimized = not minimized
    if minimized then
        TweenService:Create(mainFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quint), {Size = UDim2.new(0,420,0,44)}):Play()
        minimizeBtn.Text = "+"
    else
        TweenService:Create(mainFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quint), {Size = UDim2.new(0,420,0,300)}):Play()
        minimizeBtn.Text = "-"
    end
end)

-- ÐÐ²Ñ‚Ð¾Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°
if Config.Xray then XrayOn(obj) end
if Config.BaseESP then
    for _,p in obj:GetChildren() do if p:IsA("Model") then CreatePlotESP(p) end end
end
if Config.PlotTimer then
    for _,p in obj:GetChildren() do if p:IsA("Model") then CreateTimeESP(p) end end
end
if Config.BestValueESP then startBrainrotEsp() end
if Config.BestPriceESP then StartBestPriceESP() end
if Config.PlayerESP then enablePlayerEsp() end
if Config.AntiRagdoll then EnableAntiRagdoll() end
if Config.AntiKnockback then EnableAntiKnockback() end
if Config.KickAfterSteal then enableKickAfterSteal() end
if Config.DeleteParts then startDeleteParts() end

saveConfig()
createNotify("NyoaSs fully loaded with shared window system!")